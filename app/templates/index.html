{# templates/index.html #}
{% extends 'base.html' %}
{% block title %}Movimientos{% endblock %}

{% block content %}
<h1>Movimientos</h1>

<!-- Toggle para mostrar/ocultar acciones -->
<div class="mb-3">
  <button id="toggle-actions-btn" class="btn btn-sm btn-outline-secondary">Mostrar acciones</button>
</div>

<form method="get">
  <!-- Fila 1: Fechas y descripción -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <label for="start_date" class="form-label">Desde</label>
      <input type="date" id="start_date" name="start_date"
             class="form-control" value="{{ start_date }}">
    </div>
    <div class="col-md-3">
      <label for="end_date" class="form-label">Hasta</label>
      <input type="date" id="end_date" name="end_date"
             class="form-control" value="{{ end_date }}">
    </div>
    <div class="col-md-4">
      <label for="desc" class="form-label">Descripción</label>
      <input type="text" id="desc" name="desc"
             class="form-control"
             placeholder="Buscar descripción..."
             value="{{ desc_query }}">
    </div>
    <div class="col-md-2 align-self-end">
      <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
  </div>

  <!-- Fila 2: Cuenta, Comercio, Categoría, Tipo contabilización -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="cuenta_id" class="form-label">Cuenta</label>
      <select id="cuenta_id" name="cuenta_id" class="form-select">
        <option value="">-- Todas --</option>
        {% if current_user.is_authenticated and current_user.is_admin() %}
          {% for cta in cuentas %}
            <option value="{{ cta.id }}" {% if cta.id|string == selected_cuenta %}selected{% endif %}>{{ cta.alias or cta.numero_cuenta }}</option>
          {% endfor %}
        {% else %}
          {% for cta in cuentas if cta.user_id == current_user.id %}
            <option value="{{ cta.id }}" {% if cta.id|string == selected_cuenta %}selected{% endif %}>{{ cta.alias or cta.numero_cuenta }}</option>
          {% endfor %}
        {% endif %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="comercio_id" class="form-label">Comercio</label>
      <select id="comercio_id" name="comercio_id" class="form-select">
        <option value="">-- Todos --</option>
        {% for c in comercios %}
          <option value="{{ c.id }}"
            {% if c.id|string == selected_comercio %}selected{% endif %}>
            {{ c.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="categoria_id" class="form-label">Categoría</label>
      <select id="categoria_id" name="categoria_id" class="form-select">
        <option value="">-- Todas --</option>
        {% for cat in categorias %}
          <option value="{{ cat.id }}"
            {% if cat.id|string == selected_categoria %}selected{% endif %}>
            {{ cat.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="tipo_contabilizacion" class="form-label">Tipo</label>
      <select id="tipo_contabilizacion" name="tipo_contabilizacion" class="form-select">
        <option value="">-- Todos --</option>
        {% for t in tipos_contabilizacion %}
          <option value="{{ t }}"
            {% if t == selected_tipo_cont %}selected{% endif %}>
            {{ t.capitalize() }}
          </option>
        {% endfor %}
      </select>
    </div>
    {# Owner filter only visible to admins #}
    {% if current_user.is_authenticated and current_user.is_admin() %}
    <div class="col-md-3">
      <label for="owner_id" class="form-label">Usuario</label>
      <select id="owner_id" name="owner_id" class="form-select">
        <option value="">-- Todos --</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if u.id|string == selected_owner %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>
</form>

<p>
  Total movimientos: {{ total_movs }} |
  Débito: Q{{ sum_debito }} |
  Crédito: Q{{ sum_credito }}
</p>

<table class="table table-striped">
  <thead>
    <tr>
  <th>Fecha</th>
  {% if current_user.is_authenticated and current_user.is_admin() %}
  <th>Usuario</th>
  {% endif %}
      <th>Descripción</th>
      <th>Lugar</th>
      <th>Documento</th>
      <th>Monto</th>
      <th>Moneda</th>
      <th>Cuenta</th>
      <th>Comercio</th>
      <th>Categoría</th>
      <th class="actions-col">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for m in movimientos %}
    <tr>
  <td>{{ m.fecha }}</td>
  {% if current_user.is_authenticated and current_user.is_admin() %}
  <td>{{ m.user.username if m.user else '-' }}</td>
  {% endif %}
      <td>{{ m.descripcion }}</td>
      <td>{{ m.lugar or '—' }}</td>
      <td>{{ m.numero_documento or '—' }}</td>
      <td>{{ m.monto }}</td>
      <td>{{ m.moneda }}</td>
      <td>{{ m.cuenta.numero_cuenta }}</td>
      <td>{{ m.comercio.nombre if m.comercio else '—' }}</td>
      <td>
        {% if m.comercio and m.comercio.categoria %}
          {{ m.comercio.categoria.nombre }}
        {% else %}
          —
        {% endif %}
      </td>
      <td class="actions-col">
        <div class="btn-group" role="group" aria-label="Acciones">
          <a href="{{ url_for('main.edit_movimiento', mov_id=m.id) }}" class="btn btn-sm btn-outline-secondary">Editar</a>
          <form method="post" action="{{ url_for('main.delete_movimiento', mov_id=m.id) }}" style="display:inline-block; margin:0;" onsubmit="return confirm('¿Eliminar este movimiento?');">
            <input type="hidden" name="next" value="{{ request.full_path }}">
            <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
          </form>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
  <script>
    (function(){
      const colClass = 'actions-col';
      const storageKey = 'show_mov_actions';
      const toggleBtn = document.getElementById('toggle-actions-btn');

      function setVisibility(show){
        document.querySelectorAll('.' + colClass).forEach(el => {
          el.style.display = show ? '' : 'none';
        });
        toggleBtn.textContent = show ? 'Ocultar acciones' : 'Mostrar acciones';
      }

      // init from localStorage
      let show = (localStorage.getItem(storageKey) === 'true');
      setVisibility(show);

      toggleBtn.addEventListener('click', function(){
        show = !show;
        localStorage.setItem(storageKey, show);
        setVisibility(show);
      });
    })();
  </script>
{% endblock %}
