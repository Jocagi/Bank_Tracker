{% extends 'base.html' %}
{% block title %}Cargar Archivo{% endblock %}
{% block content %}
<h1>Cargar Archivo</h1>
<form method="post" enctype="multipart/form-data">
  <div class="mb-3">
    <label for="tipo_archivo" class="form-label">Tipo Archivo</label>
    <select class="form-select" name="tipo_archivo" id="tipo_archivo" required>
      <option value="monet-aho-gyt">Monetaria/Ahorro GYT</option>
      <option value="tc-gyt">Tarjeta de Crédito GYT</option>
      <option value="monet-bi">Monetaria BI</option>
      <option value="monet-bi-email">Monetaria BI (Email)</option>
      <option value="tc-bi">Tarjeta de Crédito BI</option>
      <option value="tc-promerica">Tarjeta de Crédito Promerica</option>
      <option value="tc-bac">Tarjeta de Crédito BAC</option>
    </select>
  </div>
  <div class="mb-3">
    <input class="form-control" type="file" name="files" id="files" accept=".xlsx,.xls,.pdf,.csv" multiple required>
    <div id="file_help" class="form-text">Extensiones permitidas: .xlsx, .xls, .pdf, .csv. Puedes seleccionar múltiples archivos de la misma categoría.</div>
  </div>
  <button type="submit" class="btn btn-primary" id="upload-btn">Cargar</button>
  <div id="file-info" class="mt-2 text-muted" style="display: none;"></div>
</form>
{% endblock %}

{% block scripts %}
<script>
  // Mapeo de tipos a extensiones según app/utils/file_loader.py
  (function(){
    const mapping = {
      'monet-aho-gyt': ['.xlsx', '.xls', '.pdf'],
      'tc-gyt': ['.xlsx', '.xls', '.pdf'],
      'monet-bi': ['.pdf'],
      'monet-bi-email': ['.pdf'],
      'tc-bi': ['.xls', '.xlsx'],
      'tc-promerica': ['.xls', '.xlsx'],
      'tc-bac': ['.csv']
    };

    function extsToAccept(exts){ return exts.join(','); }
    function extsToLabel(exts, typeName){
      return 'Archivo (' + typeName + ') [' + exts.join(' ') + ']';
    }

    function update(){
      const select = document.getElementById('tipo_archivo');
      const files = document.getElementById('files');
      const help = document.getElementById('file_help');

      if (!select) { console.warn('select #tipo_archivo not found'); return; }
      if (!files || !help) { console.warn('files/help element missing', {files, help}); }

      const val = select.value;
      const typeName = (select.options && select.selectedIndex >= 0) ? select.options[select.selectedIndex].text : '';
      const exts = mapping[val] || ['.csv', '.txt', '.xls', '.xlsx', '.pdf'];

      if (files) files.setAttribute('accept', extsToAccept(exts));
      if (help) help.textContent = 'Extensiones permitidas: ' + exts.join(', ') + '. Puedes seleccionar múltiples archivos de la misma categoría.';

      console.debug('upload form updated', {tipo: val, typeName, exts});
    }

    function updateFileInfo(){
      const filesInput = document.getElementById('files');
      const fileInfo = document.getElementById('file-info');
      
      if (filesInput && fileInfo) {
        const fileCount = filesInput.files.length;
        if (fileCount === 0) {
          fileInfo.style.display = 'none';
        } else if (fileCount === 1) {
          fileInfo.textContent = `1 archivo seleccionado: ${filesInput.files[0].name}`;
          fileInfo.style.display = 'block';
        } else {
          fileInfo.textContent = `${fileCount} archivos seleccionados`;
          fileInfo.style.display = 'block';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      const select = document.getElementById('tipo_archivo');
      const filesInput = document.getElementById('files');
      const form = document.querySelector('form');
      const uploadBtn = document.getElementById('upload-btn');
      
      if (select) select.addEventListener('change', update);
      if (filesInput) filesInput.addEventListener('change', updateFileInfo);
      
      // Mostrar indicador de carga al enviar
      if (form) {
        form.addEventListener('submit', function(){
          if (uploadBtn) {
            uploadBtn.textContent = 'Cargando...';
            uploadBtn.disabled = true;
          }
        });
      }
      
      update(); // inicial
    });
  })();
</script>
{% endblock %}