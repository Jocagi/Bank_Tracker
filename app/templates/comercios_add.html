{% extends 'base.html' %}
{% block title %}Agregar Comercio{% endblock %}
{% block content %}
<h1>Agregar Comercio</h1>
<form method="post">
  <div class="mb-3">
    <label class="form-label">Nombre</label>
    <input class="form-control" name="nombre" value="{{ pre_nombre }}" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Categoría</label>
    <select class="form-select" name="categoria_id">
      {% for cat in categorias %}<option value="{{ cat.id }}">{{ cat.nombre }}</option>{% endfor %}
    </select>
  </div>
  <div class="mb-3">
  <label class="form-label">Tipo de contabilización</label>
  <select name="tipo_contabilizacion" class="form-select" required>
    <option value="ingresos">Ingresos</option>
    <option value="gastos" selected>Gastos</option>
    <option value="transferencias">Transferencias</option>
  </select>
</div>
  <div id="reglas-container">
    <label class="form-label">Reglas de Clasificación</label>
    <div class="regla-row mb-2">
      <input name="reg_descripcion" placeholder="Descripción" value="{{ pre_nombre if pre_nombre else 'Regla automática' }}" class="form-control d-inline w-50" required>
      <select name="reg_tipo" class="form-select d-inline w-auto">
        <option value="incluir">Incluir</option>
        <option value="excluir">Excluir</option>
    </select>
    <input name="reg_criterio" placeholder="Criterio (Usa * como comodín)" value="{{ pre_regla }}" class="form-control d-inline w-25" required>
    <button type="button" class="btn btn-danger btn-sm remove-regla">✕</button>
  </div>
</div>
<button type="button" class="btn btn-secondary mb-3" onclick="agregarRegla()">Agregar regla</button>
  <button class="btn btn-primary">Guardar</button>
  {% if error %}
  <div class="alert alert-danger mt-3">{{ error }}</div>
  {% endif %}
</form>

<script>
  function agregarRegla() {
    const container = document.getElementById('reglas-container');
    const existingRow = document.querySelector('.regla-row');
    
    let newRow;
    if (existingRow) {
      // Si hay una fila existente, clonarla
      newRow = existingRow.cloneNode(true);
      newRow.querySelectorAll('input').forEach(input => input.value = '');
      newRow.querySelector('select').value = 'incluir';
    } else {
      // Si no hay filas, crear una nueva desde cero
      newRow = document.createElement('div');
      newRow.className = 'regla-row mb-2';
      newRow.innerHTML = `
        <input name="reg_descripcion" placeholder="Descripción" class="form-control d-inline w-50" required>
        <select name="reg_tipo" class="form-select d-inline w-auto">
          <option value="incluir">Incluir</option>
          <option value="excluir">Excluir</option>
        </select>
        <input name="reg_criterio" placeholder="Criterio (Usa * como comodín)" class="form-control d-inline w-25" required>
        <button type="button" class="btn btn-danger btn-sm remove-regla">✕</button>
      `;
    }
    
    container.appendChild(newRow);
  }

  document.getElementById('reglas-container').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-regla')) {
      e.target.closest('.regla-row').remove();
    }
  });
</script>
{% endblock %}