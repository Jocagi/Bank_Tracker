{# templates/dashboard.html #}
{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1>Dashboard de Movimientos</h1>

<form method="get" class="row g-3 mb-4">
  <div class="col-md-3">
    <label for="start_date" class="form-label">Desde</label>
    <input type="date" id="start_date" name="start_date"
           class="form-control" value="{{ start_date }}">
  </div>
  <div class="col-md-3">
    <label for="end_date" class="form-label">Hasta</label>
    <input type="date" id="end_date" name="end_date"
           class="form-control" value="{{ end_date }}">
  </div>
  <div class="col-md-3">
    <label for="category_id" class="form-label">Categor√≠a</label>
    <select id="category_id" name="category_id" class="form-select">
      <option value="">-- Todas --</option>
      {% for cat in categorias %}
        <option value="{{ cat.id }}"
          {% if cat.id|string == selected_cat %}selected{% endif %}>
          {{ cat.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>
  {% if current_user.is_authenticated and current_user.is_admin() %}
  <div class="col-md-3">
    <label for="owner_id" class="form-label">Usuario</label>
    <select id="owner_id" name="owner_id" class="form-select">
      <option value="">-- Todos --</option>
      {% for u in users %}
      <option value="{{ u.id }}" {% if selected_owner and (selected_owner|string) == (u.id|string) %}selected{% endif %}>{{ u.username }}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
  <div class="col-md-3">
    <label for="table_limit" class="form-label">Elementos a mostrar</label>
    <select id="table_limit" name="table_limit" class="form-select">
      <option value="5" {% if table_limit and table_limit|string == "5" %}selected{% endif %}>5 elementos</option>
      <option value="10" {% if not table_limit or table_limit|string == "10" %}selected{% endif %}>10 elementos</option>
      <option value="15" {% if table_limit and table_limit|string == "15" %}selected{% endif %}>15 elementos</option>
      <option value="20" {% if table_limit and table_limit|string == "20" %}selected{% endif %}>20 elementos</option>
      <option value="0" {% if table_limit and table_limit|string == "0" %}selected{% endif %}>Todos</option>
    </select>
  </div>
  <div class="col-12 text-end">
    <button type="submit" class="btn btn-primary">Aplicar filtros</button>
    <a href="{{ url_for('main.dashboard', clear_filters='true') }}" class="btn btn-outline-secondary ms-2">Limpiar filtros</a>
  </div>
</form>

<div class="row mb-3">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0">Evoluci√≥n Mensual de Gastos</h6>
      </div>
      <div class="card-body p-2" style="height: 350px;">
        <canvas id="chartMonthly"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0">Gastos por Comercio</h6>
      </div>
      <div class="card-body p-2" style="height: 275px;">
        <canvas id="chartCommerce"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0">Gastos por Categor√≠a</h6>
      </div>
      <div class="card-body p-2" style="height: 275px;">
        <canvas id="chartCategory"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Gr√°ficas adicionales -->
<div class="row mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0">Top 10 Gastos Individuales</h6>
      </div>
      <div class="card-body p-2" style="height: 275px;">
        <canvas id="chartTopGastos"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0">Gastos por D√≠a de la Semana</h6>
      </div>
      <div class="card-body p-2" style="height: 275px;">
        <canvas id="chartWeekday"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Gr√°ficas adicionales compactas -->
<div class="row mb-3">
  <div class="col-12 mb-2">
    <h5>üìä An√°lisis Avanzado de Gastos</h5>
  </div>
  
  <!-- Primera fila: Gr√°ficas principales m√°s grandes -->
  <div class="col-lg-6 col-md-6 mb-3">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0 small">Gastos por Cuenta</h6>
      </div>
      <div class="card-body p-2" style="height: 315px;">
        <canvas id="chartCuentas"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-lg-6 col-md-6 mb-3">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0 small">Distribuci√≥n por Rangos</h6>
      </div>
      <div class="card-body p-2" style="height: 315px;">
        <canvas id="chartRangos"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Segunda fila: Gr√°ficas secundarias m√°s compactas -->
<div class="row mb-3">
  <div class="col-lg-4 col-md-6 mb-3">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0 small">Recurrentes vs √önicos</h6>
      </div>
      <div class="card-body p-2" style="height: 188px;">
        <canvas id="chartRecurrentes"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-6 mb-3">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0 small">Gastos por Moneda</h6>
      </div>
      <div class="card-body p-2" style="height: 188px;">
        <canvas id="chartMonedas"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-12 mb-3">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0 small">Top Comercios Recurrentes</h6>
      </div>
      <div class="card-body p-2" style="height: 188px;">
        <canvas id="chartComerciosRecurrentes"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Tercera fila: Heatmap ocupando todo el ancho -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header p-2">
        <h6 class="mb-0 small">üìÖ Heatmap de Gastos Diarios (√öltimo a√±o - 365 d√≠as)</h6>
      </div>
      <div class="card-body p-3">
        <div id="heatmapCalendar" class="heatmap-container">
          <!-- El heatmap se generar√° aqu√≠ con JavaScript -->
        </div>
        <div class="heatmap-legend">
          <span style="font-size: 10px;">Menos</span>
          <div class="heatmap-legend-item heatmap-level-0"></div>
          <div class="heatmap-legend-item heatmap-level-1"></div>
          <div class="heatmap-legend-item heatmap-level-2"></div>
          <div class="heatmap-legend-item heatmap-level-3"></div>
          <div class="heatmap-legend-item heatmap-level-4"></div>
          <span style="font-size: 10px;">M√°s</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <!-- Gastos por Comercio -->
  <div class="col-md-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Gastos por Comercio (GTQ)</h5>
      <button class="btn btn-sm btn-outline-secondary toggle-table" data-table="commerce">
        <span class="toggle-text">Ver menos</span>
      </button>
    </div>
    <table class="table table-sm table-bordered" id="commerce-table">
      <thead>
        <tr>
          <th>Comercio</th>
          <th class="text-end">Total Q</th>
        </tr>
      </thead>
      <tbody>
        {% for label, total in commerce_table %}
        <tr class="table-row" data-index="{{ loop.index0 }}">
          <td>{{ label }}</td>
          <td class="text-end">{{ '%.2f'|format(total) }}</td>
        </tr>
        {% endfor %}
        {% if not commerce_table %}
        <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Gastos por Categor√≠a -->
  <div class="col-md-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Gastos por Categor√≠a (GTQ)</h5>
      <button class="btn btn-sm btn-outline-secondary toggle-table" data-table="category">
        <span class="toggle-text">Ver menos</span>
      </button>
    </div>
    <table class="table table-sm table-bordered" id="category-table">
      <thead>
        <tr>
          <th>Categor√≠a</th>
          <th class="text-end">Total Q</th>
        </tr>
      </thead>
      <tbody>
        {% for label, total in category_table %}
        <tr class="table-row" data-index="{{ loop.index0 }}">
          <td>{{ label }}</td>
          <td class="text-end">{{ '%.2f'|format(total) }}</td>
        </tr>
        {% endfor %}
        {% if not category_table %}
        <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Ingresos por Comercio -->
  <div class="col-md-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Ingresos por Comercio (GTQ)</h5>
      <button class="btn btn-sm btn-outline-secondary toggle-table" data-table="income">
        <span class="toggle-text">Ver menos</span>
      </button>
    </div>
    <table class="table table-sm table-bordered" id="income-table">
      <thead>
        <tr>
          <th>Comercio</th>
          <th class="text-end">Total Q</th>
        </tr>
      </thead>
      <tbody>
        {% for label, total in income_table %}
        <tr class="table-row" data-index="{{ loop.index0 }}">
          <td>{{ label }}</td>
          <td class="text-end">{{ '%.2f'|format(total) }}</td>
        </tr>
        {% endfor %}
        {% if not income_table %}
        <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .heatmap-container {
      display: grid;
      grid-template-columns: repeat(53, 1fr); /* 53 semanas (365 d√≠as) */
      grid-template-rows: repeat(7, 1fr);     /* 7 d√≠as de la semana */
      gap: 2px;
      padding: 10px;
      max-width: 100%;
      margin: 0 auto;
      overflow-x: auto;
    }
    
    .heatmap-day {
      width: 12px;
      height: 12px;
      background-color: #ebedf0;
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }
    
    .heatmap-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 10px;
      font-size: 11px;
    }
    
    .heatmap-legend-item {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    
    .heatmap-day:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 1000;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
    }
    
    /* Intensidades de color para el heatmap */
    .heatmap-level-0 { background-color: #ebedf0; }
    .heatmap-level-1 { background-color: #c6e48b; }
    .heatmap-level-2 { background-color: #7bc96f; }
    .heatmap-level-3 { background-color: #239a3b; }
    .heatmap-level-4 { background-color: #196127; }
  </style>
  <script>
    // Funcionalidad de colapso de tablas
    document.addEventListener('DOMContentLoaded', function() {
      const tableLimit = document.getElementById('table_limit');
      
      // Funci√≥n para aplicar l√≠mite a una tabla
      function applyTableLimit(tableId, limit) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const rows = table.querySelectorAll('tbody .table-row');
        
        rows.forEach((row, index) => {
          if (limit === 0 || index < limit) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
        
        // Actualizar texto del bot√≥n
        const button = table.closest('.col-md-4').querySelector('.toggle-table');
        const toggleText = button.querySelector('.toggle-text');
        
        if (limit === 0 || rows.length <= limit) {
          toggleText.textContent = 'Ver menos';
          button.disabled = rows.length <= 5;
        } else {
          const hiddenCount = rows.length - limit;
          toggleText.textContent = `Ver ${hiddenCount} m√°s`;
          button.disabled = false;
        }
      }
      
      // Funci√≥n para alternar vista completa de una tabla
      function toggleTableView(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const button = table.closest('.col-md-4').querySelector('.toggle-table');
        const toggleText = button.querySelector('.toggle-text');
        const rows = table.querySelectorAll('tbody .table-row');
        const currentLimit = parseInt(tableLimit.value);
        
        const isExpanded = toggleText.textContent === 'Ver menos';
        
        if (isExpanded && currentLimit > 0) {
          // Colapsar a la cantidad seleccionada
          applyTableLimit(tableId, currentLimit);
        } else {
          // Expandir todo
          applyTableLimit(tableId, 0);
        }
      }
      
      // Event listener para el selector de l√≠mite
      tableLimit.addEventListener('change', function() {
        const limit = parseInt(this.value);
        applyTableLimit('commerce-table', limit);
        applyTableLimit('category-table', limit);
        applyTableLimit('income-table', limit);
        // Actualizar gr√°ficos tambi√©n
        updateCommerceChart(limit);
        updateCategoryChart(limit);
      });
      
      // Event listeners para botones de toggle
      document.querySelectorAll('.toggle-table').forEach(button => {
        button.addEventListener('click', function() {
          const tableId = this.getAttribute('data-table') + '-table';
          toggleTableView(tableId);
        });
      });
      
      // Aplicar l√≠mite inicial (usar el valor que viene del servidor o 10 por defecto)
      const initialLimit = parseInt(tableLimit.value) || 10;
      applyTableLimit('commerce-table', initialLimit);
      applyTableLimit('category-table', initialLimit);
      applyTableLimit('income-table', initialLimit);
      
      // Crear gr√°ficos iniciales
      updateCommerceChart(initialLimit);
      updateCategoryChart(initialLimit);
    });

    // Datos para los gr√°ficos
    const commerceLabels  = {{ commerce_labels  | tojson }};
    const commerceValues  = {{ commerce_values  | tojson }};
    const categoryLabels  = {{ cat_labels       | tojson }};
    const categoryValues  = {{ cat_values       | tojson }};
  const monthLabels     = {{ month_labels     | tojson }};
  const monthValues     = {{ month_values     | tojson }};
  const monthIncomeValues = {{ month_income_values | tojson }};
  
  // Datos para nuevas gr√°ficas
  const topGastosLabels = {{ top_gastos_labels | tojson }};
  const topGastosValues = {{ top_gastos_values | tojson }};
  const weekdayLabels   = {{ weekday_labels   | tojson }};
  const weekdayValues   = {{ weekday_values   | tojson }};
  
  // Datos para gr√°ficas adicionales
  const rangosLabels = {{ rangos_labels | tojson }};
  const rangosValues = {{ rangos_values | tojson }};
  const heatmapDates = {{ heatmap_dates | tojson }};
  const heatmapAmounts = {{ heatmap_amounts | tojson }};
  const recurrentesLabels = {{ recurrentes_labels | tojson }};
  const recurrentesValues = {{ recurrentes_values | tojson }};
  const cuentasLabels = {{ cuentas_labels | tojson }};
  const cuentasValues = {{ cuentas_values | tojson }};
  const monedasLabels = {{ monedas_labels | tojson }};
  const monedasValues = {{ monedas_values | tojson }};

  // Datos para comercios recurrentes
  const comerciosRecurrentesLabels = {{ comercios_recurrentes_labels | tojson }};
  const comerciosRecurrentesValues = {{ comercios_recurrentes_values | tojson }};

    // Variables para almacenar las instancias de los gr√°ficos
    let chartCommerce, chartCategory;

    // Funci√≥n para procesar datos del gr√°fico seg√∫n el l√≠mite
    function processChartData(labels, values, limit) {
      if (limit === 0 || labels.length <= limit) {
        return { labels, values };
      }
      
      const limitedLabels = labels.slice(0, limit);
      const limitedValues = values.slice(0, limit);
      
      // Sumar el resto en "Otros"
      const othersSum = values.slice(limit).reduce((sum, val) => sum + Math.abs(val), 0);
      
      if (othersSum > 0) {
        limitedLabels.push('Otros');
        limitedValues.push(othersSum);
      }
      
      return { labels: limitedLabels, values: limitedValues };
    }

    // Funci√≥n para crear/actualizar gr√°fico de comercio
    function updateCommerceChart(limit) {
      const { labels, values } = processChartData(commerceLabels, commerceValues, limit);
      
      if (chartCommerce) {
        chartCommerce.destroy();
      }
      
      chartCommerce = new Chart(document.getElementById('chartCommerce'), {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{ data: values }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  const v = Math.abs(ctx.parsed).toLocaleString(undefined, { minimumFractionDigits: 2 });
                  return `${ctx.label}: Q${v}`;
                }
              }
            },
            legend: {
              position: 'bottom',
              labels: { font: { size: 11 } }
            }
          }
        }
      });
    }

    // Funci√≥n para crear/actualizar gr√°fico de categor√≠as
    function updateCategoryChart(limit) {
      const { labels, values } = processChartData(categoryLabels, categoryValues, limit);
      
      if (chartCategory) {
        chartCategory.destroy();
      }
      
      chartCategory = new Chart(document.getElementById('chartCategory'), {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{ data: values }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  const v = Math.abs(ctx.parsed).toLocaleString(undefined, { minimumFractionDigits: 2 });
                  return `${ctx.label}: Q${v}`;
                }
              }
            },
            legend: {
              position: 'bottom',
              labels: { font: { size: 11 } }
            }
          }
        }
      });
    }

    // L√≠nea: Evoluci√≥n Mensual de Gastos e Ingresos
    new Chart(document.getElementById('chartMonthly'), {
      type: 'line',
      data: {
        labels: monthLabels,
        datasets: [
          {
            label: 'Gastos Q',
            data: monthValues,
            borderColor: 'rgba(220,53,69,0.9)', // bootstrap danger
            backgroundColor: 'rgba(220,53,69,0.1)',
            fill: false,
            tension: 0.1
          },
          {
            label: 'Ingresos Q',
            data: monthIncomeValues,
            borderColor: 'rgba(25,135,84,0.9)', // bootstrap success
            backgroundColor: 'rgba(25,135,84,0.1)',
            fill: false,
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                // ctx.datasetIndex tells which series; ctx.parsed.y is the value
                const v = Math.abs(ctx.parsed.y).toLocaleString(undefined, { minimumFractionDigits: 2 });
                return `${ctx.dataset.label}: Q${v}`;
              }
            }
          },
          legend: {
            display: true,
            position: 'top',
            labels: { font: { size: 12 } }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            ticks: { font: { size: 11 } }
          },
          x: {
            ticks: { font: { size: 11 } }
          }
        }
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Gr√°fica de Top 10 Gastos
    const ctxTopGastos = document.getElementById('chartTopGastos').getContext('2d');
    new Chart(ctxTopGastos, {
      type: 'bar',
      data: {
        labels: topGastosLabels,
        datasets: [{
          label: 'Monto Q',
          data: topGastosValues,
          backgroundColor: 'rgba(220,53,69,0.7)',
          borderColor: 'rgba(220,53,69,0.9)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = Math.abs(ctx.parsed.x).toLocaleString(undefined, { minimumFractionDigits: 2 });
                return `Gasto: Q${v}`;
              }
            }
          },
          legend: { display: false }
        },
        scales: {
          x: { 
            beginAtZero: true,
            ticks: { font: { size: 10 } }
          },
          y: {
            ticks: { font: { size: 10 } }
          }
        }
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Gr√°fica de Gastos por D√≠a de Semana
    const ctxWeekday = document.getElementById('chartWeekday').getContext('2d');
    new Chart(ctxWeekday, {
      type: 'bar',
      data: {
        labels: weekdayLabels,
        datasets: [{
          label: 'Gastos Q',
          data: weekdayValues,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',   // Domingo
            'rgba(54, 162, 235, 0.7)',   // Lunes
            'rgba(255, 205, 86, 0.7)',   // Martes
            'rgba(75, 192, 192, 0.7)',   // Mi√©rcoles
            'rgba(153, 102, 255, 0.7)',  // Jueves
            'rgba(255, 159, 64, 0.7)',   // Viernes
            'rgba(199, 199, 199, 0.7)'   // S√°bado
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 205, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(199, 199, 199, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = Math.abs(ctx.parsed.y).toLocaleString(undefined, { minimumFractionDigits: 2 });
                return `Gastos: Q${v}`;
              }
            }
          },
          legend: { display: false }
        },
        scales: {
          y: { 
            beginAtZero: true,
            ticks: { font: { size: 10 } }
          },
          x: {
            ticks: { font: { size: 10 } }
          }
        }
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Gr√°fica de Distribuci√≥n por Rangos
    const ctxRangos = document.getElementById('chartRangos').getContext('2d');
    new Chart(ctxRangos, {
      type: 'bar',
      data: {
        labels: rangosLabels,
        datasets: [{
          label: 'Cantidad de Gastos',
          data: rangosValues,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 205, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 205, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.parsed.y} gastos`
            }
          },
          legend: { display: false }
        },
        scales: {
          y: { 
            beginAtZero: true,
            ticks: { font: { size: 10 } }
          },
          x: {
            ticks: { font: { size: 10 } }
          }
        }
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Gr√°fica de Gastos Recurrentes vs √önicos
    const ctxRecurrentes = document.getElementById('chartRecurrentes').getContext('2d');
    new Chart(ctxRecurrentes, {
      type: 'doughnut',
      data: {
        labels: recurrentesLabels,
        datasets: [{
          data: recurrentesValues,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.toLocaleString(undefined, { minimumFractionDigits: 2 });
                return `${ctx.label}: Q${v}`;
              }
            }
          },
          legend: { 
            position: 'bottom',
            labels: { font: { size: 10 } }
          }
        }
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Gr√°fica de Gastos por Cuenta
    const ctxCuentas = document.getElementById('chartCuentas').getContext('2d');
    new Chart(ctxCuentas, {
      type: 'pie',
      data: {
        labels: cuentasLabels,
        datasets: [{
          data: cuentasValues,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 205, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.toLocaleString(undefined, { minimumFractionDigits: 2 });
                return `${ctx.label}: Q${v}`;
              }
            }
          },
          legend: { 
            position: 'bottom',
            labels: { font: { size: 9 } }
          }
        }
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Gr√°fica de Gastos por Moneda
    const ctxMonedas = document.getElementById('chartMonedas').getContext('2d');
    new Chart(ctxMonedas, {
      type: 'pie',
      data: {
        labels: monedasLabels,
        datasets: [{
          data: monedasValues,
          backgroundColor: [
            'rgba(75, 192, 192, 0.7)',
            'rgba(255, 205, 86, 0.7)',
            'rgba(255, 99, 132, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.toLocaleString(undefined, { minimumFractionDigits: 2 });
                return `${ctx.label}: Q${v}`;
              }
            }
          },
          legend: { 
            position: 'bottom',
            labels: { font: { size: 9 } }
          }
        }
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Heatmap de calendario real con cuadr√≠cula
    function createHeatmapCalendar() {
      const container = document.getElementById('heatmapCalendar');
      container.innerHTML = '';
      
      // Crear un mapa de fechas a montos
      const dataMap = {};
      heatmapDates.forEach((date, index) => {
        dataMap[date] = heatmapAmounts[index];
      });
      
      // Calcular niveles de intensidad
      const maxAmount = Math.max(...heatmapAmounts.filter(amount => amount > 0));
      const getLevel = (amount) => {
        if (amount === 0) return 0;
        if (amount <= maxAmount * 0.2) return 1;
        if (amount <= maxAmount * 0.4) return 2;
        if (amount <= maxAmount * 0.7) return 3;
        return 4;
      };
      
      // Generar grid de 53 semanas x 7 d√≠as (365 d√≠as)
      const today = new Date();
      const startDate = new Date(today);
      startDate.setDate(today.getDate() - 365); // 365 d√≠as = ~53 semanas
      
      // Ajustar para empezar en lunes
      const startDay = startDate.getDay();
      const daysToMonday = startDay === 0 ? 1 : startDay - 1;
      startDate.setDate(startDate.getDate() - daysToMonday);
      
      // Crear cuadr√≠cula de 53 columnas (semanas) x 7 filas (d√≠as)
      const grid = [];
      for (let week = 0; week < 53; week++) {
        for (let day = 0; day < 7; day++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + (week * 7) + day);
          
          if (currentDate <= today) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const amount = dataMap[dateStr] || 0;
            const level = getLevel(amount);
            
            const dayElement = document.createElement('div');
            dayElement.className = `heatmap-day heatmap-level-${level}`;
            dayElement.style.gridColumn = week + 1;
            dayElement.style.gridRow = day + 1;
            dayElement.setAttribute('data-tooltip', 
              `${dateStr}: Q${amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}`
            );
            
            container.appendChild(dayElement);
          }
        }
      }
    }
    
    // Crear el heatmap
    createHeatmapCalendar();

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Gr√°fica de Comercios M√°s Recurrentes
    const ctxComerciosRecurrentes = document.getElementById('chartComerciosRecurrentes').getContext('2d');
    new Chart(ctxComerciosRecurrentes, {
      type: 'bar',
      data: {
        labels: comerciosRecurrentesLabels,
        datasets: [{
          label: 'Transacciones',
          data: comerciosRecurrentesValues,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y', // Barras horizontales
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.parsed.x} transacciones`
            }
          },
          legend: { display: false }
        },
        scales: {
          x: { 
            beginAtZero: true,
            ticks: { font: { size: 10 } }
          },
          y: {
            ticks: { 
              font: { size: 9 },
              callback: function(value, index) {
                // Truncar nombres largos
                const label = this.getLabelForValue(value);
                return label.length > 15 ? label.substring(0, 15) + '...' : label;
              }
            }
          }
        }
      }
    });
  </script>
{% endblock %}
