{% extends 'base.html' %}
{% block title %}Administración de Archivos{% endblock %}
{% block content %}
<h1>Administración de Archivos</h1>

<form method="get" class="row g-3 mb-4">
  <div class="col-md-3">
    <label class="form-label">Tipo de Archivo</label>
    <select class="form-select" name="tipo_archivo">
      <option value="">-- Todos --</option>
      {% for t in tipos %}
      <option value="{{ t }}" {% if t == type_selected %}selected{% endif %}>
        {{ t }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Desde</label>
    <input type="date"
           name="start_date"
           class="form-control"
           value="{{ start_date or '' }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Hasta</label>
    <input type="date"
           name="end_date"
           class="form-control"
           value="{{ end_date or '' }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Nombre de archivo</label>
    <input type="text"
           name="filename"
           class="form-control"
           placeholder="Buscar..."
           value="{{ filename_query or '' }}">
  </div>
  <div class="col-12">
    <button class="btn btn-primary">Filtrar</button>
    <a href="{{ url_for('main.list_archivos') }}" class="btn btn-secondary ms-2">Limpiar</a>
  </div>
</form>

{# Owner filter for admins #}
{% if current_user.is_authenticated and current_user.is_admin() %}
<form method="get" class="mb-3 row g-3">
  <div class="col-md-4">
    <label class="form-label">Usuario</label>
    <select name="owner_id" class="form-select">
      <option value="">-- Todos --</option>
      {% for u in users %}
      <option value="{{ u.id }}" {% if u.id|string == selected_owner %}selected{% endif %}>{{ u.username }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2 align-self-end">
    <button class="btn btn-primary">Filtrar</button>
    <a href="{{ url_for('main.list_archivos') }}" class="btn btn-secondary ms-2">Limpiar</a>
  </div>
</form>
{% endif %}

<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Usuario</th>
      <th>Nombre</th>
      <th>Tipo</th>
      <th>Fecha Carga</th>
      <th># Movimientos</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for a in archivos %}
    <tr>
      <td>{{ a.id }}</td>
      <td>{{ a.user.username if a.user else '-' }}</td>
      <td>{{ a.filename }}</td>
      <td>{{ a.tipo_archivo }}</td>
      <td>{{ a.upload_date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
      <td>{{ a.movimientos|length }}</td>
      <td>
        <div class="btn-group" role="group" aria-label="Acciones archivo">
          <a href="{{ url_for('main.archivos_movimientos', archivo_id=a.id) }}" class="btn btn-sm btn-outline-primary">Ver movimientos</a>
          <form method="post"
                action="{{ url_for('main.delete_archivo', archivo_id=a.id) }}"
                style="display:inline-block; margin:0;"
                onsubmit="return confirm('¿Eliminar este archivo y todos sus movimientos?');">
            <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
          </form>
        </div>
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="6" class="text-center text-muted">
        No se encontraron archivos.
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
